---
title: "Inital Report"
author: "CCBR scRNAseq pipeline"
output: html_document
params:
  matrix: "path/to/count/matrix"
  species: "hg19"
  projectId: "<projectId>"
  projectDesc: "<desc>"
---

```{r headers, include=FALSE, warning=FALSE, message=FALSE}
projectId<-params$projectId
projectDesc<-params$projectDesc
dateandtime<-format(Sys.time(), "%a %b %d %Y - %X")
species<-params$species
matrix<-params$matrix
```

### **Project:**
####    *`r projectId`*
### **Description:** 
####    *`r projectDesc`*
### **Report generated:** 
####    *`r dateandtime`* 

```{r setup, echo=FALSE, warning=FALSE,message=FALSE,results='hide',fig.keep='all'}
# library(rgl)
library(knitr)
library(Seurat)
library(dplyr)
library(Matrix)
library(scater)
library(scran)
library(limma)

# knit_hooks$set(rgl = function(before, options, envir) {
#   if (!before) {
#     ## after a chunk has been evaluated
#     if (rgl.cur() == 0) return()  # no active device
#     name = paste(options$fig.path, options$label, sep = '')
#     rgl.snapshot(paste(name, '.png', sep = ''), fmt = 'png')
#     return(paste('\\includegraphics{', name, '}\n', sep = ''))
#   }
# })

#knit_hooks$set(webgl = hook_webgl)

sce <- read10XResults(data_dir = matrix, min_total_cell_counts = 0, min_mean_gene_counts = 0, expand = TRUE)

is.mito <- grepl("^MT-",fData(sce)$symbol)|grepl("^mt-",fData(sce)$symbol)
sce <- calculateQCMetrics(sce, feature_controls=list(Mt=is.mito))
libsize.drop <- isOutlier(sce$total_counts, nmads=3, type="lower", log=TRUE)
feature.drop <- isOutlier(sce$total_features, nmads=3, type="lower", log=TRUE)
mito.drop <- isOutlier(sce$pct_counts_feature_controls_Mt, nmads=3, type="higher")
sce_filtered <- sce[,!(libsize.drop | feature.drop | mito.drop)]
numcells <- nexprs(sce_filtered, byrow=TRUE)
keepgenes <- numcells >= round(0.001*ncol(sce))
sce_filtered <- sce_filtered[keepgenes,]
numdroppedgenes <- sum(!keepgenes)
keepcells <- rownames(sce_filtered@phenoData)
droppedcells <- setdiff(rownames(sce@phenoData),keepcells)

so.data <- Read10X(matrix)
so <- new("seurat", raw.data=so.data)
so <- Setup(so, min.genes=0, min.cells=0, do.logNormalize=F, do.scale=F, do.center=F, project=projectId)
so <- SubsetData(so, cells.use=keepcells)
so@raw.data <- so@data
so <- Setup(so, min.genes=0, min.cells=round(0.001*ncol(sce)), do.logNormalize=T, do.scale=F, do.center=F, total.expr=1e4, project=projectId, save.raw=F)
```
### **Pre-Filter Histograms**

```{r histograms, echo=FALSE,warning=FALSE,message=FALSE}
hist(sce$total_counts, xlab="Library sizes", main="", 
    breaks=20, col="grey80", ylab="Number of cells")
hist(sce$total_features, xlab="Number of expressed genes", main="", 
    breaks=20, col="grey80", ylab="Number of cells")
hist(sce$pct_counts_feature_controls_Mt, xlab="Mitochondrial proportion (%)", 
    ylab="Number of cells", breaks=20, main="", col="grey80")
sce<-sce_filtered
```

### **Removed** `r numdroppedgenes` **lowly represented genes from count matrix.**  

### **Removed the following** `r length(droppedcells)` **barcoded cells as poor quality:**  


```{r filter_metrics, echo=FALSE, message=FALSE, warning=FALSE, results='asis'}
kable(data.frame(ByLibSize=sum(libsize.drop), ByFeature=sum(feature.drop), ByMito=sum(mito.drop), Remaining=ncol(sce)))
cat("  \n")
cat(unlist(droppedcells))
cat("  \n")
```

### **nGenes vs nUMI** (Useful for outlier detection)

```{r nUMI_plot, echo=FALSE, message=FALSE, warning=FALSE}
GenePlot(so, "nUMI", "nGene")
```

### **Cell Cycle Stage**

```{r cell_cycle, echo=FALSE,warning=FALSE,message=FALSE}
if(grepl("hg",species)|grepl("mm",species)){
  if(grepl("hg",species)){
    pairs <- readRDS(system.file("exdata", "human_cycle_markers.rds", package="scran"))
  }
  if(grepl("mm",species)){
    pairs <- readRDS(system.file("exdata", "mouse_cycle_markers.rds", package="scran"))
  }
  assignments <- cyclone(sce_filtered, pairs, gene.names=rownames(sce_filtered))
  plot(assignments$score$G1, assignments$score$G2M, xlab="G1 score", ylab="G2/M score", pch=16, 
    col = ifelse((assignments$score$G1>=0.5)&(assignments$score$G2M<0.5),'green','orange'))
  abline(h=0.5,col="red")
  abline(v=0.5,col="red")
  legend("topleft", "[G2/M]", bty="n", text.col="red")
  legend("topright", "[?]", bty="n", text.col="red")
  legend("bottomleft", "[S]", bty="n", text.col="red")
  legend("bottomright", "[G1]", bty="n", text.col="red")
}
sce$G1score <- assignments$score$G1
sce$G2Mscore <- assignments$score$G2M
```
### **PCA 1:2 Before Regressing Cell Cycle Stage**

```{r regress_confounding, echo=FALSE,warning=FALSE,message=FALSE,message=FALSE,results='hide',fig.keep='all'}
norm_exprs(sce) <- removeBatchEffect(exprs(sce), covariates=data.frame(assignments$score[,c("G1", "G2M")],percent.mito=sce$pct_counts_feature_controls_Mt,nUMI=so@data.info$nUMI))
stage <- c()
for(i in 1:length(sce$G1score)){
  if(sce$G1score[i] >= 0.5 & sce$G2Mscore[i] >= 0.5){
    stage[i] <- "???"
  }else if(sce$G1score[i] >= 0.5){
    stage[i] <- "G1"
  }else if(sce$G2Mscore[i] >= 0.5){
    stage[i] <- "G2M"
  }else{
    stage[i] <- "S"
  }
}
metadata <- data.frame(percent.mito=sce$pct_counts_feature_controls_Mt,G1.score=sce$G1score,G2M.score=sce$G2Mscore,stage=stage,row.names=colnames(sce))
so <- AddMetaData(so, metadata)
so_temp <- RegressOut(so, latent.vars = c("nUMI", "percent.mito"))
so_temp <- MeanVarPlot(so_temp ,fxn.x = expMean, fxn.y = logVarDivMean, x.low.cutoff = 0.0125, x.high.cutoff = 3, y.cutoff = 0.5, do.contour = F, do.plot=F)
so_temp <- PCA(so_temp, pc.genes = so_temp@var.genes, do.print = FALSE)
so_temp <- ProjectPCA(so_temp,do.print=F)
PCAPlot(so_temp, 1, 2, group.by="stage",cols.use=c(rgb(1, 0, 0, 0.7),rgb(0, 1, 0, 0.3),rgb(0, 0, 1, 0.7),rgb(0, 0, 0, 0.7)))
so <- RegressOut(so, latent.vars = c("nUMI", "percent.mito", "G1.score", "G2M.score"))
```

### **PCA 1:2 Before Regressing Cell Cycle Stage**

```{r regress_confounding_final, echo=FALSE,warning=FALSE,message=FALSE,message=FALSE,results='hide',fig.keep='all'}
so <- RegressOut(so, latent.vars = c("nUMI", "percent.mito", "G1.score", "G2M.score"))
so <- MeanVarPlot(so ,fxn.x = expMean, fxn.y = logVarDivMean, x.low.cutoff = 0.0125, x.high.cutoff = 3, y.cutoff = 0.5, do.contour = F, do.plot=F)
so <- PCA(so, pc.genes = so@var.genes, do.print = FALSE)
so <- ProjectPCA(so,do.print=F)
PCAPlot(so, 1, 2, group.by="stage",cols.use=c(rgb(1, 0, 0, 0.7),rgb(0, 1, 0, 0.3),rgb(0, 0, 1, 0.7),rgb(0, 0, 0, 0.7)))
```

### **Highest Expression**

```{r highestexpression, echo=FALSE,warning=FALSE,message=FALSE}
fontsize <- theme(axis.text=element_text(size=12), axis.title=element_text(size=16))
plotQC(sce, type = "highest-expression", n=50) + fontsize
```

### **PC Metrics**

```{r findpcs, echo=FALSE,warning=FALSE,message=FALSE}
plotQC(sce, type = "find-pcs") + fontsize
```

### **MeanVar Plot**
```{r Seurat_meanvar, echo=FALSE,warning=FALSE,message=FALSE,results='hide',fig.keep='all'}
so <- MeanVarPlot(so ,fxn.x = expMean, fxn.y = logVarDivMean, x.low.cutoff = 0.0125, x.high.cutoff = 3, y.cutoff = 0.5, do.contour = F)
```

### **PCs**

```{r Seurat_pcas, echo=FALSE,warning=FALSE,message=FALSE,results='hide',fig.keep='all'}
so <- PCA(so, pc.genes = so@var.genes, do.print = FALSE)
so <- ProjectPCA(so,do.print=F)
```

### **PCA Plots**

```{r Seurat_pcaplots, echo=FALSE,warning=FALSE,message=FALSE}
PCAPlot(so, 1, 2)
```

### **Heatmaps**

```{r Seurat_heatmaps, echo=FALSE,warning=FALSE,message=FALSE}
#PCHeatmap(so, pc.use = 1:20, cells.use = 500, do.balanced = TRUE, label.columns = FALSE, use.full = FALSE)
```

### **JackStraw Plot**

```{r Seurat_jackstraw, echo=FALSE,warning=FALSE,message=FALSE}
#so <- JackStraw(so, num.replicate = 100, do.print = FALSE)
#JackStrawPlot(so, PCs = 1:20)

```

### **PCElbowPlot**

```{r Seurat_elbow, echo=FALSE,warning=FALSE,message=FALSE}
PCElbowPlot(so)
```
